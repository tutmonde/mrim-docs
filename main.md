# Основное

_[Вернуться к оглавлению](readme.md)_

## Подключение к серверу

Для подключения к серверу MRIM используются порты 2041 и 2042. 

*2041* это основной порт для сервера MRIM, *2042* - некий перенаправлятор на основной порт. Официальный клиент первым делом подключается к 2042, чтобы узнать самый оптимальный сервер для подключения для распределения нагрузки.

Перенаправляющий сервер всегда отвечает в таком формате: `IP:PORT` либо `HOSTNAME:PORT`, с символом новой строки в конце (байт `0A`). Например: `3.46.15.201:2042`. После ответа сервер мгновенно сбрасывает соединение.

Далее, клиент будет обязан подключиться к этому серверу и отправить пакет `MRIM_CS_HELLO`. Это будет рассматриваться в разделе "Авторизация".

## Как составляется пакет

Протокол MRIM - байтовый, и пакеты у него составляются побайтово. Для чисел используется Little Endinan, когда первым идёт старший байт.

В нём используется два типа данных:

| Тип данных | Описание | Пример | Расшифровка |
| ---------- | -------- | ------ | ----------- |
| UL         | Четырёхбатовое число | `1B 00 00 00` | 27 |
| LPS        | Строка, перед которой всегда идёт её длинна в формате UL | `05 00 00 00 48 65 6C 6C 6F` | Hello (длина 5) |

LPS всегда имеет кодировку Windows-1251, если не указано иное.
Однако, начиная с MRIM 1.16 был введен utf-16le в некоторых местах, учтите это при реализации

Пакет составляется таким образом: сначала идёт заголовок, а потом данные. Также клиент может отдать заголовок и данные отдельными пакетами.

> [!CAUTION]
> Информация про разделённые пакеты пока не подтверждалась на практике. При этом стоит отметить, что так работали некоторые реализации протокола

Заголовок выглядит так:

| Тип данных | Значение | Описание |
| -------- | ------ | ----------- |
| N/A | `EF BE AD DE` | Магический заголовок. Также разделяет пакеты между друг другом |
| UL | `0D 00 01 0A` | Версия протокола. Нашим сервером дублируется версия из ответа клиента |
| UL | `0A 00 00 00` | Очередь пакета. Обычно плюсуется к предыдущему, но в новых версиях генерируется |
| UL | `01 10 00 00` | Команда. В примере используется `MRIM_CS_HELLO` |
| UL | `32 00 00 00` | Размер пакета без заголовка |
| UL | `00 00 00 00` | IP адрес отправителя. Не используется и заполняется нулями |
| UL | `00 00 00 00` | Порт отправителя. Не используется и заполняется нулями |
| UL x 4 | `00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00` | Зарезервировано. Всегда заполняется нулями |

Команда указывается в HEX формате, написанная справа от её названия в документации. После заголовка идут данные, составленные из UL и LPS.


