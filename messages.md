# Сообщения

## `MESSAGE` (0x1008) C -> S

Сообщение. Обычное, пользовательское.

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| US         | N/A                  | Флаги сообщения   |
| LPS        | `example@mail.ru`    | Получатель        |
| LPS        | `Hello world!`       | Сообщение в формате Plain text |
| LPS        | N/A                  | Сообщение в формате RTF |

Сообщение может быть отправлено только либо в формате Plain text, либо ещё RTF. Отправлять просто RTF без простого текста нельзя.  

RTF сообщение зашифровано в Gzip. Расшифрованный формат выглядит примерно так:

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| US         | `02 00 00 00`        | Количество LPS    |
| LPS        | N/A                  | RTF               |
| LPS        | N/A                  | Цвет фона в формате UL (???) |

Что курили разработчики протокола, когда создавали третий параметр - не очень ясно.

В случае с авторизацией расшифрованный RTF должен составляться так: 

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| US         | `02 00 00 00`        | Количество LPS    |
| LPS        | N/A                  | Ник, формат Plain Text |
| LPS        | N/A                  | Текст запроса авторизации в формате RTF |

В случае с флагом 0x00000400, Plain text и RTF должны состоять из одного пробела.

В случае с флагом 0x00001000, В Plain text и RTF должна написана инфа о будильнике в текстовом формате.

**TODO: расшифровка RTF в случае с флеш мультиками**

Возможные флаги (Можно комбинировать):

* 0x00000001 - Сообщение было отправлено, пока пользователь был оффлайн **(клиенту запрещено его отправлять)**
* 0x00000004 - Подтверждение доставки не требуется (сервер не отсылает `MESSAGE_STATUS`)
* 0x00000008 - Запрос на авторизацию
* 0x00000040 - Системное сообщение **(клиенту запрещено его отправлять)**
* 0x00000080 - Сообщение содержит RTF
* 0x00000200 - Сообщение - пересланный список контактов. Формат: _адрес_;_ник_;...
* 0x00000400 - Уведомление типа "вам пишут...". Серверу не обязательно отсылать обратно `MESSAGE_STATUS`
* 0x00001000 - Сообщение направлено не одному получателю. В поле "получатель" список пользователей должен быть перечислен слитно через запятую. Максимум - 50 человек.
* 0x00004000 - Будильник
* 0x00008000 - Flash-мультик

После отправки сообщения клиент обязан дождаться от сервера команды `MESSAGE_STATUS` 

## `MESSAGE_ACK` (0x1009) S -> C

Сообщение. Обычное, пользовательское. Только он от сервера уже идёт.

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| US         | N/A                  | Айди сообщения. Присваивается рандомный на сервере |
| US         | N/A                  | Флаги сообщения   |
| LPS        | `example@mail.ru`    | Отправитель        |
| LPS        | `Hello world!`       | Сообщение в формате Plain text |
| LPS        | N/A                  | Сообщение в формате RTF |

Флаги и формат RTF тот же, что был описан в команде `MESSAGE`.

Клиент должен отправить в ответ `MESSAGE_RECV`.

## `MESSAGE_RECV` (0x1011) C -> S

Уведомление от клиента о том, что сообщение успешно получено.

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| US         | N/A                  | Айди сообщения. Присваивается рандомный на сервере |
| LPS        | `example@mail.ru`    | Отправитель       |

## `MESSAGE_STATUS` (0x100F) S -> C

Посылается сервером в ответ на `MESSAGE` с кодом ошибки

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| US         | N/A                  | Код ошибки        |

Возможные коды ошибки:

- 0x0000 - Доставлено
- 0x8001 - Пользователя не существует
- 0x8003 - Внутренняя ошибка сервера
- 0x8004 - Лимит оффлайн сообщений
- 0x8005 - Сообщение слишком большое
- 0x8006 - Пользователь не принимает оффлайн-сообщения
