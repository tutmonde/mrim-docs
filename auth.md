# Авторизация

_[Вернуться к оглавлению](readme.md)_

Для авторизации используется следующий порядок команд:

1. `MRIM_CS_HELLO` (0x1001) Клиент -> Сервер
2. `MRIM_CS_HELLO_ACK` (0x1002) Сервер -> Клиент
3. `MRIM_CS_LOGIN2` (0x1038) Клиент -> Сервер
4. `MRIM_CS_LOGIN_ACK` (0x1004) Сервер -> Клиент (*в случае, если логин и пароль был верным*)
5. `MRIM_CS_LOGIN_REJ` (0x1005) Сервер -> Клиент (*в ином случае*)

*Команды для сервера или клиента будут обозначаться как __C -> S__ и __S -> C__. Если такого обозначения нет, то команда двухнаправленная*

## `MRIM_CS_HELLO` (0x1001) C -> S

Это первый запрос, который должен отправить клиент при подключении к серверу. Команда отправляется без данных после заголовка.

## `MRIM_CS_HELLO_ACK` (0x1002) S -> C

Ответ от сервера, с единственным UL в данных. 

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| UL         | `05 00 00 00`        | Таймер для команды `MRIM_CS_PING` |

Клиент обязан отсылать через определённый сервером промежуток времени команду `MRIM_CS_PING`, в ином случае сервер разорвёт соединение с клиентом.

## `MRIM_CS_PING` (0x1006) C -> S

Пинг, который необходимо отсылать для сервера. Всегда отправляется без данных, сервер на эту команду отвечать не должен.

## `MRIM_CS_SSL` (0x1086) C -> S

Запрос безопасного соединения (SSL). Сервер должен отправить эту команду после завершения инициализации SSL

## `MRIM_CS_OK` (0x1087) S -> C

Подтверждение чего-либо. Сервер может ответить этим при запросе `MRIM_CS_SSL` и `MRIM_CS_COMPRESS_SERVER_STREAM`.

В случае с `MRIM_CS_SSL` сервер должен ответить этой командой и после этого инициализировать TLS подключение.

В случае с `MRIM_CS_COMPRESS_SERVER_STREAM`, похоже, начать как-то упаковывать данные.

## `MRIM_CS_FAILURE` (0x1088) S -> C

Ошибка. Сервер может ответить этим при запросе `MRIM_CS_SSL` и `MRIM_CS_COMPRESS_SERVER_STREAM`

## `MRIM_CS_COMPRESS_SERVER_STREAM` (0x1089) C -> S

Просьба клиента сжимать данные. Чем, и как, мы не знаем, поэтому на это можно ответить `MRIM_CS_FAILURE` (0x1088), клиент не обидется. 

А если вы осмелитесь попробовать разобраться в компрессии, отправьте `MRIM_CS_OK` (0x1087).

## `MRIM_CS_LOGIN` (0x1003) C -> S

Самый 1 вариант пакета авторизации. Использовался в клиентах версии ниже 4.2

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| LPS        | N/A                  | Логин |
| LPS        | N/A                  | Пароль (в открытом виде) |

При успешной авторизации сервер отошлёт пустой `MRIM_CS_LOGIN_ACK` (0x1004), а за ним `MRIM_CS_USER_INFO` (0x1015) с данными пользователя и `MRIM_CS_CONTACT_LIST` (0x100B) со списком контактов. 

Очевидно, что передавать `MRIM_CS_CONTACT_LIST2` бесполезно, так как он предназначен для `MRIM_CS_LOGIN2`

## `MRIM_CS_LOGIN2` (0x1038) C -> S

2 вариант пакета авторизации, использовался с версии 4.2 по 5.6

*Описание для MRA 4.2-4.10*

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| LPS        | N/A                  | Логин |
| LPS        | N/A                  | Пароль (в открытом виде) |
| UL         | `01 00 00 00`        | Статус при авторизации (значения описаны в разделе "Контакты") |
| LPS        | N/A                  | Информация о клиенте |

Также официальный клиент отправляет данные после обязательных:

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| UL         | `A0 07 00 00`        | Номер билда клиента (Индивидуально для оф. клиента, не обязателен) |
| UL         | `FF FF FF FF`        | ??? (оф. клиент, не обязателен) |
| UL         | `0A 00 00 00`        | ??? (оф. клиент, не обязателен) |
| UL         | `FF FF FF FF`        | ??? (оф. клиент, не обязателен) |
| UL         | `01 00 00 00`        | ??? (оф. клиент, не обязателен) |
| UL         | `01 00 00 00`        | ??? (оф. клиент, не обязателен) |
| UL         | `01 00 00 00`        | ??? (оф. клиент, не обязателен) |

При успешной авторизации сервер отошлёт пустой `CS_LOGIN_ACK` (0x1004), а за ним `USER_INFO` (0x1015) с данными пользователя.

*Описание для MRA 5.0*

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| LPS        | `starwear3000@mail.ru` | Логин |
| LPS        | `qwerty` | Пароль (в открытом виде) |
| UL         | `01 00 00 00` | Статус при авторизации (значения описаны в разделе "Контакты") |
| LPS        | `STATUS_ONLINE` | Значение хстатуса |
| LPS        | `Онлайн` | Заголовок хстатуса |
| LPS        | N/A | Описание хстатуса |
| UL         | `FF 03 00 00` | ??? |
| LPS        | `client="magent" version="5.0" build="2094"` | 1 версия в формате `client="название_клиента" version="номер_версии" build="номер_билда"` |
| LPS        | `MRA 5.0 (build 2094);` | 2 версия |

При успешной авторизации сервер отошлёт пустой `MRIM_CS_LOGIN_ACK` (0x1004), а за ним `MRIM_CS_USER_INFO` (0x1015) с данными пользователя.

## `MRIM_CS_LOGIN_ACK` (0x1004) и `MRIM_CS_LOGIN_REJ` (0x1005) S -> C

Эти команды - успешная и неуспешная авторизация. При LOGIN_ACK отправляется без данных.

В случае с LOGIN_REJ отправляется единственный LPS с причиной:

* `Invalid login` - неверный логин
* `Database error` - внутренняя ошибка
* `Access denied` - вход запрещён, аккаунт аннигилирован или забанен
* `Black-List IP` - IP в стоп-листе

## `MRIM_CS_LOGOUT` (0x1013) S -> C

Принудительный выход из аккаунта с последующим закрытием соединения. Отправляется сервером с одним UL. Обычно отправляется, если на аккаунт зашли с другого компьютера.

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| UL         | `10 00 00 00`        | Причина выхода |

Возможные причины (указан в 16-ричном формате):

* `10` - Был выполнен вход с другого компьютера

## `MRIM_CS_USER_INFO` (0x1015) S -> C

Информация о пользователе. Отправляется сервером после `MRIM_CS_LOGIN_ACK`.

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| LPS        | MRIM.NICKNAME        | Всегда равен представленному здесь содержанию |
| LPS        | N/A                  | Имя/Ник пользователя |
| LPS        | MESSAGES.TOTAL       | Всегда равен представленному здесь содержанию |
| LPS        | N/A                  | Количество пришедших писем на электронную почту |
| LPS        | MESSAGES.UNREAD      | Всегда равен представленному здесь содержанию |
| LPS        | N/A                  | Количество непрочитанных сообщений на эл. почте |
| LPS        | client.endpoint      | Всегда равен представленному здесь содержанию |
| LPS        | `127.0.0.1:13562`    | IP и порт с которого идет подключение к серверу |






