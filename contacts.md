# Контакты

_[Вернуться к оглавлению](readme.md)_

## `MRIM_CS_CONTACT_LIST2` (0x1037) S -> C

Список контактов. Контакт-лист пользователя хранится на сервере. Клиент может хранить локальную копию контакт-листа, но серверная должна иметь приоритет. Должен всегда отправляться после `MRIM_CS_USER_INFO`. Индекс групп всегда начинается с 0 и каждый список контактов должен иметь хотя бы 1 группу.

> [!CAUTION]
> Поведение у каждой версии протокола может быть кардинально разным, при реализации не описанных тут версий учтите это

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| UL         | `00 00 00 00`        | Код ошибки |
| UL         | `04 00 00 00`        | Количество групп |
| LPS        | `us`                 | Флаги групп. Должен соответствовать содержанию |
| LPS        | `uussuus`*           | Флаги контактов. Должен соответствовать в соответствии версии протокола клиента |

Возможные коды ошибки:

* 0x0 - Успех
* 0x1 - Ошибка
* 0x2 - Внутренняя ошибка

Возможные маски контактов*:
* uussuu - Версия MRIM 1.7 (MRA 4.2)
* uussuus - Версия MRIM 1.8-1.13 (MRA 4.3-4.10)
* uussuussssus - Версия MRIM 1.15 (MRA 5.0)

Далее идут группы:

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| UL         | `00 00 00 00`        | Флаги группы |
| LPS        | `General`            | Название группы |

Далее идут контакты:

*Описание для MRA 4.2 (uussuu)*

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| UL         | `00 00 00 00`        | Флаги    |
| UL         | `00 00 00 00`        | Индекс группы |
| LPS        | `example@mail.ru`    | Почта (юзернейм) пользователя |
| LPS        | `Пример`             | Имя пользователя. Если его нет, используется юзернейм |
| UL         | `00 00 00 00`        | Авторизован ли контакт. Равен единице или нулю |
| UL         | `00 00 00 00`        | Статус контакта. Клиент игнорирует это поле, если контакт неавторизован |

*Описание для MRA 4.3-4.10 (uussuus)*

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| UL         | `00 00 00 00`        | Флаги    |
| UL         | `00 00 00 00`        | Индекс группы |
| LPS        | `example@mail.ru`    | Почта (юзернейм) пользователя |
| LPS        | `Пример`             | Имя пользователя. Если его нет, используется юзернейм |
| UL         | `00 00 00 00`        | Авторизован ли контакт. Равен единице или нулю |
| UL         | `00 00 00 00`        | Статус контакта. Клиент игнорирует это поле, если контакт неавторизован |
| LPS        | `79005678943`        | Номер телефона (в случае отсутствия отправляется пустой LPS) |

## `MRIM_CS_CHANGE_STATUS` (0x1022) C -> S

Смена статуса пользователем на другой.

| Тип данных | Примерное содержание | Значение |
| ---------- | -------------------- | -------- |
| UL         | `01 00 00 00`        | Статус   |

Возможные статусы:

* _0x1_ - Онлайн
* _0x2_ - Отошёл
* _0x80000001_ - Невидимка

## `MRIM_CS_USER_STATUS` (0x100f) S -> C

У пользователя сменился статус. Клиент должен его будет обновить у себя

| Тип данных | Примерное содержание | Значение     |
| ---------- | -------------------- | ------------ |
| UL         | `01 00 00 00`        | Статус       |
| LPS        | `example@mail.ru`    | Пользователь |

## `MRIM_CS_ADD_CONTACT` (0x1019) C -> S

Добавление клиентом пользователя в список контактов ИЛИ создание группы. Сервер должен отправить в ответ `MRIM_CS_ADD_CONTACT_ACK`, клиент должен дождаться его

| Тип данных | Примерное содержание | Значение      |
| ---------- | -------------------- | ------------- |
| UL         | `01 00 00 00`        | Флаги         |
| UL         | `01 00 00 00`        | Индекс группы |
| LPS        | `example@mail.ru`    | E-mail ИЛИ название группы |
| LPS        | `Пример`             | Кастомный никнейм для отображения в контактах       |
| LPS        | N/A                  | _Не используется, зарезервировано_       |

Возможные флаги:

* 0x01 - Удалить контакт (не применим для `MRIM_CS_ADD_CONTACT`)
* 0x02 - **Создание группы**
* 0x04 - Контакт должен попасть в список "Всегда невидим для"
* 0x08 - Контакт должен попасть в список "Всегда видим для"
* 0x10 - Контакт должен попасть в список игнорируемых
* 0x20 - Контакт не должен попасть в основной список контактов (может применяться в паре с тремя предыдущими правилами путём сложения, например: 0x20 + 0x04 = 0x24 = Не попадает в основной список и попадает в список "Всегда невидим для")

В случае с созданием группы (флаг 0x02) поля для индекса группы и кастомного никнейма не заполняются. У групп есть лимит по их количеству - максимум UInt32 (около 4-х миллионов), однако рекомендуется выставить искуственное ограничение в 15 групп.

## `MRIM_CS_ADD_CONTACT_ACK` (0x101A) S -> C

Ответ сервера на `MRIM_CS_ADD_CONTACT`

| Тип данных | Примерное содержание | Значение        |
| ---------- | -------------------- | --------------- |
| UL         | `00 00 00 00`        | Код ошибки      |
| UL         | N/A                  | Индекс контакта |

Второе значение - индекс контакта в списке, как он показывается в клиенте.

Возможные коды ошибки:

* 0x0 - Успех
* 0x1 - Ошибка
* 0x2 - Внутренняя ошибка
* 0x3 - Пользователя не существует
* 0x4 - Неверные данные
* 0x5 - Пользователь уже существует в контактах
* 0x6 - Превышен лимит по группам

В случае ошибки индекс контакта равен 0xffffffff.

## `MRIM_CS_MODIFY_CONTACT` (0x101B) C -> S

Редактирование контакта или группы. Сервер должен будет отправить ответ `MRIM_CS_MODIFY_CONTACT_ACK`

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| UL         | N/A                  | Индекс контакта   |
| UL         | N/A                  | Флаги             |
| UL         | N/A                  | Индекс группы     |
| LPS        | `example@mail.ru`    | Email контакта    |
| LPS        | `Пример`             | Никнейм контакта  |
| LPS        | N/A                  | _Зарезервировано_ |

Флаги те же, что и у `ADD_CONTACT`.

## `MRIM_CS_MODIFY_CONTACT_ACK` (0x101C) S -> C

Ответ сервера на `MRIM_CS_MODIFY_CONTACT`.

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| UL         | N/A                  | Код ошибки        |

Коды ошибок те же, что и у `MRIM_CS_ADD_CONTACT_ACK`.

## `MRIM_CS_AUTHORIZE` (0x1020) C -> S

Просьба клиента авторизовать контакт у пользователя. Обычно отсылается вместе с командой `MRIM_CS_MESSAGE`. Клиент не должен дожидаться ответа от сервера. Если сторонний пользователь согласился на авторизацию, ему придёт `MRIM_CS_AUTHORIZE_ACK`.

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| LPS        | `example@mail.ru`    | Пользователь, который клиент хочет авторизовать |

## `MRIM_CS_AUTHORIZE_ACK` (0x1021) S -> C

Приходит клиенту от пользователя, который его авторизовал.

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| LPS        | `example@mail.ru`    | Пользователь, которого клиент авторизовал |




