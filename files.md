# Передача файлов

_[Вернуться к оглавлению](readme.md)_

## Как устроена передача файлов?

1. клиент-отправитель -> FILE_TRANSFER -> клиент-получатель
2. клиент-получатель -> FILE_TRANSFER_ACK -> клиент-отправитель
3. клиент-получатель по списку IP адресов пробует подключаться к клиенту-отправителю

Если коннект удался, то происходит обмен файлами и при окончании дисконнект

Если нет, то сначала клиент-отправитель пытается подключиться к клиенту-получателю, и если и это не получается, клиенты запрашивают у сервера прокси `FILE_TRANSFER_MIRROR` через команду `MRIM_CS_FILE_TRANSFER_ACK`. 

_TODO: написать про зеркало_

## Общение между клиентами

При успешном соединении клиент-отправитель посылает `MRA_FT_HELLO {ПОЧТА}\0`, и ждёт ответа от клиента-получателя той же командой `MRA_FT_HELLO {ПОЧТА}\0`. При её получении клиент-получатель отправляет `MRA_FT_GET_FILE {НАЗВАНИЕ_ФАЙЛА}\0`, клиент-отправитель отправляет файл частями в 1460 байт или меньше, после чего отключается.

## `MRIM_CS_FILE_TRANSFER` (0x1026) C <-> S

Запрос на передачу файлов. Двухнаправленный

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| LPS        | `example@mail.ru`    | От кого (если сообщение получает клиент) или куда (если отправляет клиент)        |
| UL         | N/A                  | Уникальный идентификатор передачи, всегда рандомный   |
| UL         | N/A                  | Размер всех файлов в байтах   |
| LPS        | N/A       | Данные с тремя LPS подстроками |

Подстроки внутри последнего LPS:

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| LPS        | `firmware.bin;3328;Bliss.jpg;51127;`       | Список всех передаваемых файлов в формате "FILENAME;SIZE;". **FILENAME** - название файла, **SIZE** - размер файла в байтах |
| LPS        | N/A       | На MRIM <= 1.14 не используется, пустой |
| LPS        | `192.168.1.30:2041;192.168.1.30:1244;`       | Список всех доступных IP адресов для подключения к хосту в повторяющемся формате "IP:PORT;" |

## `MRIM_CS_FILE_TRANSFER_ACK` (0x1027) C <-> S

Ответ на передачу файлов. Двухнаправленный

| Тип данных | Примерное содержание | Значение          |
| ---------- | -------------------- | ----------------- |
| UL         | `01 00 00 00`                  | Статус передачи   |
| LPS        | `example@mail.ru`    | От кого (если сообщение получает клиент) или куда (если отправляет клиент)        |
| UL         | N/A                  | Уникальный идентификатор передачи, всегда рандомный   |
| LPS        | `192.168.1.30:2041;192.168.1.30:1244;`       | Список доступных для подключения IP адресов в повторяющемся формате `IP:PORT;` |

Статусы могут быть следующие:

- _0x1_ - пользователь принял файл
- _0x0_ - пользователь отклонил
- _0x2_ - неизвестная ошибка
- _0x3_ - несовместимая версия клиента (предположительно MRA 2.55 и ниже)
- _0x4_ - от сервера требуется прокси
